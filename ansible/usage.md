# Usage for Covalic Ansible

This guidance assumes that Covalic will be developing using pods of EC2 instances,
each pod is a separate group that provides the full functionality of Covalic, which
at current time is

  * Girder webserver instance
  * Mongodb instance
  * RabbitMQ + Celery worker instance

The following two environment variables need to be set with your AWS access credentials

  1. export AWS_ACCESS_KEY_ID=your_id
  2. export AWS_SECRET_ACCESS_KEY=your_key

The two pods that currently exist are `dev` and `prod`. The `dev` pod is
for development testing, and is turned off unless it's being actively used for
testing. The `prod` pod is the main production deployment and is always on.

The first time you want to interact with a running pod from a fresh checkout of this
codebase, you'll need to use the `utils/build_pod_inventory.sh` script:

    ./utils/build_pod_inventory.sh <POD> <PATH_TO covalic_admin.pem>

That will create the appropriate inventory file for that pod in your `pod_inventory`
directory, and you will then be able to reference that pod in other operations.

## SSH to an EC2 instance

Because we use Ubuntu images, `ubuntu` is the root user

    ssh -i <PATH_TO covalic_admin.pem> ubuntu@<ec2-instance-public-dns>

## Common workflows

Below are detailed descriptions of individual steps, but here are listed likely
common workflows.

### Create a new pod and provision it

    python utils/create_pod_s3_assetstore.py <POD>
    ./utils/create.sh <POD>
    ./utils/provision.sh <POD>

### Start and update a stopped pod

    ./utils/start_pod.sh <POD>
    ./utils/build_pod_inventory.sh <POD> <PATH_TO covalic_admin.pem>
    ./utils/rewire.sh <POD>
    ./utils/update.sh <POD>

### Start and update a stopped pod with specific repo versions

    ./utils/start_pod.sh <POD>
    ./utils/build_pod_inventory.sh <POD> <PATH_TO covalic_admin.pem>
    ./utils/rewire.sh <POD>
    ansible-playbook provision.yml -i pod_inventory/<POD>_pod -e pod=<POD> -e covalic_version=<VERSION> -t deploy-update --vault-password vault-password.txt

## Pod lifecycle control

These depend on having a valid `pod_static_vars/<POD>_instance_ids` file, which is a static
file containing the instance_ids for the pods.  This somewhat goes against the
idea of dynamically targeting instances in EC2, but this gets around a limitation
in that the ec2.py dynamic inventory script will not include EC2 instances that
are in the `stopped` state.

`pod_static_vars/<POD>_instance_ids` is generated by create.yml, but
it could easily be created by hand.


### Create a pod

    ./utils/create.sh <POD>

This command will create a pod named <POD> consisting of servers

  1. Girder webserver
  2. Mongodb server
  3. RabbitMQ server with a Celery worker

, create two security groups

  1. webserver_`<POD>`
  2. backend_`<POD>`

, place the Girder webserver in the webserver_`<POD>` security group, place the
Mongodb server and the RabbitMQ servers in the backend_`<POD>` security groups,
and register the instance ids for the servers in `pod_static_vars/<POD>_instance_ids`.

### Starting a pod

To start a pod that is not currently running

    ./utils/start_pod.sh <POD>

### Stopping a pod

To stop a pod that is currently running

    ./utils/stop_pod.sh <POD>

### Provisioning a pod

#### Build a pod inventory and refresh pod variables

The pods and instances are dynamic, and may be brought up and down as needed.  When
instances are brought up, their properties including (DNS, internal IP, external IP) will
change, and since these values are used to configure a pod, these values will need
to be refreshed.

The first step is to build a pod inventory so that it can be targeted.

    ./utils/build_pod_inventory.sh <POD> <PATH_TO covalic_admin.pem>

This will create files that will be used by provisioning steps, these should not
be added to Git

  1. pod_inventory/`<POD>`_pod
  2. pod_dynamic_vars/`<POD>`_vars.yml

#### Create an S3 Assetstore

    python utils/create_pod_s3_assetstore.py <POD>

You will probably only need to do this once at the start of working with a given pod.
Calling this script will create

  1. S3 bucket with the name `covalic-<POD>-assetstore`
  2. IAM user that can use the S3 bucket
  3. file at path `pod_static_vars/<POD>_s3_assetstore.yml`

The file created will have variables holding everything needed to create an S3
assetstore in Girder and will allow Girder to communicate with S3.  The file
will also be encrypted (double check this before committing) so that it can be
safely added to GitHub.

#### Fully provision a pod

To provision a pod fully after creating the pod and the S3 assetstore, or in case
there are large scale changes to update

    ./utils/provision.sh <POD>

#### Rewire a pod

After bringing a pod back up, and building the pod inventory and refreshing the
pod variables, you can rewire the services together.

    ./utils/rewire.sh <POD>

#### Update a pod with the latest codebase

To update a pod with the latest codebase from the repos

    ./utils/update.sh <POD>

To update a pod with a specific version of a repo, set an environment variable
for any of the following.  The default value for each is `master`, except for
`covalic_metrics_version`, which defaults to `latest`.

    challenge_version
    covalic_version
    girder_version
    covalic_metrics_version

Then run the update like

    ansible-playbook provision.yml -i pod_inventory/<POD>_pod -e pod=<POD> -e covalic_version=<VERSION> -t deploy-update --vault-password vault-password.txt

### Using Ansible vault for sensitive data

This presupposes you have access to the shared `vault-password.txt` file, which should
be placed in the `ansible` dir.

#### Encrypting a file

Create a standard Ansible yaml variable file and then encrypt it before checking
into the Git repo.  **Warning**: this will encrypt the file in place.

    ansible-vault encrypt <PATH_TO_SENSITIVE_FILE> --vault-password-file vault-password.txt

#### Using the encrypted data in an Ansible command

The scripts in the `utils` dir make use of encrypted variable files like

    ansible-playbook provision.yml -i <INVENTORY> -e pod=<POD> -t <TAG> --vault-password-file vault-password.txt
