# Usage for Covalic Ansible

This guidance assumes that Covalic will be developing using pods of EC2 instances,
each pod is a separate group that provides the full functionality of Covalic, which
at current time is

  * Girder webserver instance
  * Mongodb instance
  * RabbitMQ + Celery worker instance

The following two environment variables need to be set with your AWS access credentials

  1. export AWS_ACCESS_KEY_ID=your_id
  2. export AWS_SECRET_ACCESS_KEY=your_key

## Pod lifecycle control

These depend on having a valid `pod_static_vars/<POD>_instance_ids` file, which is a static
file containing the instance_ids for the pods.  This somewhat goes against the
idea of dynamically targeting instances in EC2, but this gets around a limitation
in that the ec2.py dynamic inventory script will not include EC2 instances that
are in the `stopped` state.

`pod_static_vars/<POD>_instance_ids` should in theory be generated by create.yml, but for
now needs to be created manually.

### Starting a pod

To start a pod that is not currently running

    ./utils/start_pod.sh <POD>

### Stopping a pod

To stop a pod that is currently running

    ./utils/stop_pod.sh <POD>

### Provisioning a pod

#### Build a pod inventory and refresh pod variables

The pods and instances are dynamic, and may be brought up and down as needed.  When
instances are brought up, their properties including (DNS, internal IP, external IP) will
change, and since these values are used to configure a pod, these values will need
to be refreshed.

The first step is to build a pod inventory so that it can be targeted.

    ./utils/build_pod_inventory.sh <POD> <PATH_TO covalic_admin.pem>

This will create files that will be used by provisioning steps, these should not
be added to Git

  1. pod_inventory/<POD>_pod
  2. pod_dynamic_vars/<POD>_vars.yml

#### Create an S3 Assetstore

You will probably only need to do this once at the start of working with a given pod.
Calling this script will create

  1. S3 bucket with the name `covalic-<POD>-assetstore`
  2. IAM user that can use the S3 bucket
  3. file at path `pod_static_vars/<POD>_s3_assetstore.yml`

The file created will have variables holding everything needed to create an S3
assetstore in Girder and will allow Girder to communicate with S3.

TODO: investigate holding this info in a vault so it can be checked into Git.
For now do not check it in.

#### full provision TODO
#### update girder TODO

#### Rewire a pod

After bringing a pod back up, and building the pod inventory and refreshing the
pod variables, you can rewire the services together.
# TODO store the girder_admin_password in a vault

    ./utils/rewire.sh <POD> <girder_admin_password>
